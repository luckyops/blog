---
title: Linux防火墙读书笔记
date: 2019-11-18 23:42:42
tags:
---
尝试使用博客来做读书笔记，《Linux防火墙(第4版)》这个是一本非常经典的讲iptables的书，虽然现在最新版的Centos已经不再使用iptables，但是比如k8s等等最新的serverless服务，底层还是基于Iptables，所以这本书还是有很高的阅读价值的。
### 第一部分 数据包的过滤以及基本的安全措施
数据包过滤防火墙的基础概念和机制，这些概念包括网络通信的参考架构、级域网络的服务是如何被识别的、什么是数据包，以及网络上的计算机互相发送消息和消息的类型。
OSI网络模型代表了基于层次的网络框架，每一层都提供了不同于其他层的功能，总共分为了7层。
物理层、数据链路层、网络层、传输层、会话层、表示层、应用层，共七层。
OSI的物理层被传输介质所占据，它们传输比特，网络入侵检测人员通常不会关注物理层。
数据链路层在给定的物理介质上传输数据，并负责传输过程中的错误检测和恢复，物理硬件地址也定义在这一层，例如MAC地址。
网络层负责逻辑寻址和数据路由，IP协议是网络层的协议，路由器和一些交换机工作在第三层。
传输层是能够建立可靠性的重要一层，传输层的协议包含TCP和UDP等，在该层上，会话在两个端点之间建立。
第六层是表示层，主要是负责与上层的应用层进行通信，还定义了使用的加密方式等。
最后是应用层，它负责向用户或者应用程序展示数据。


#### IP协议，IP是互联网运行的基础，IP是无连接的协议，它提供第三层的路由功能。
```bash 
# 特殊地址
0.0.0.0 代表默认路由
127.0.0.1  回环网络地址，不会被路由，指向本机
255.255.255.255 广播地址，会被路由，传递到物理网段的所有主机
```
有时IP数据报的大小比它将要通过的物理介质所允许的最大大小要大，这个所允许的最大大小是最大传输单元MTU，这时候将要在传输前分割成更小的块，这个过程称为分片。
分片在OSI的网络层(IP层)进行，因此它对于高层的协议(比如TCP、UDP)而言是透明的，如果分片的某个大片段丢失了，将会影响程序的性能。
在过去，分片是一种攻击方式，通讯路径中的任何中介路由都有可能导致分片。
#### 广播和组播
除了寻址到这个数据本身的数据帧外，还有广播和组播这两种方式会导致接口接收数据。
广播会被所有接收到广播的设备处理，分直接广播和受限广播，目前前者更常见，因为地址解析协议（ARP）使用广播来获得子网中的一个IP地址对应的MAC地址。
通常一个路由接口遇到了一个直接广播，它不会将该数据报传递到可路由的其他子网中。大多数的路由可以进行配置以允许此行为，然而，应该谨慎些，以免造成网络风暴。
一个子网广播是发送给定子网的广播地址数据帧，该广播地址根据要发送的子网掩码不同而不同。
#### ICMP
ICMP通常用于ping服务。

#### 传输层机制 TCP、UDP
UDP是无连接协议，用于DNS查询、SNMP（简单网络管理协议）和RADIUS（远程用户拨号认证系统）等。
TCP是面向连接等协议，意味着它向上提供可靠的服务。两个应用程序用TCP通信，必须建立一个连接。
TCP的三次建立连接握手分别是 SYN(SYN_SEND状态)>SYN-ACK(SYN_RCVD)>ACK(ESTABLISHED) 连接此时已经建立成功。
(SYN_SEND)SYN > (LISTEN)
(ESTABLISHED) < SYN-ACK(SYN_RCVD)
(ESTABLISHED) ACK > (ESTABLISHED)
TCP的四次挥手比建立连接多一次的原因是因为TCP连接的全双工特性，因为任何一遍都可能在任何时候发送数据。
断开分别是
(ESTABLISHED) FIN > (ESTABLISHED)
(FIN_WAIT1) < ACK (CLOSE_WAIT)
(FIN_WAIT2) < FIN (LAST_ACK)
(TIME_WAIT) FIN-ACK > (CLOSE)
(CLOSE)